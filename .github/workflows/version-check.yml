name: Version Check

on:
  pull_request:
    paths:
      - 'Cargo.toml'
      - 'CHANGELOG.md'

jobs:
  version-check:
    name: Version Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check semver format
        run: |
          VERSION=$(grep "^version" Cargo.toml | sed 's/.*version = "\(.*\)".*/\1/')
          echo "Checking version: $VERSION"

          # Regex for semver: X.Y.Z[-prerelease][+build]
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?(\+[a-zA-Z0-9.]+)?$'; then
              echo "❌ Version $VERSION doesn't match semantic versioning format"
              exit 1
          fi

          echo "✅ Version format valid"

      - name: Check CHANGELOG updated
        run: |
          # For non-dev versions, CHANGELOG should be updated
          VERSION=$(grep "^version" Cargo.toml | sed 's/.*version = "\(.*\)".*/\1/')

          if [[ ! "$VERSION" =~ dev$ ]]; then
              if ! grep -q "## \[$VERSION\]" CHANGELOG.md; then
                  echo "❌ CHANGELOG.md not updated for version $VERSION"
                  exit 1
              fi
          fi

          echo "✅ CHANGELOG.md updated"

      - name: Verify no duplicate versions in CHANGELOG
        run: |
          # Check for duplicate version headers
          if [ "$(grep -c '^## \[' CHANGELOG.md)" != \
               "$(grep '^## \[' CHANGELOG.md | sort -u | wc -l)" ]; then
              echo "❌ CHANGELOG.md has duplicate version headers"
              exit 1
          fi

          echo "✅ No duplicate versions in CHANGELOG"