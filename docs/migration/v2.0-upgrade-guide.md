# Upgrade Guide: pg_tviews 1.x → 2.0

This guide helps you migrate your code from v1.x to v2.0.

**Estimated time**: 30 minutes to 2 hours (depends on usage)

## Prerequisites

- [ ] Backup your database before starting
- [ ] Test upgrade in staging environment first
- [ ] Review [BREAKING_CHANGES_V2.0.md](../BREAKING_CHANGES_V2.0.md) for full details
- [ ] Plan rollback procedures (see rollback section below)

## Breaking Changes Overview

### 1. Function Renaming (REQUIRED)

**Change**: `refresh_pk()` → `refresh_tview_row()`

**Before (v1.x)**:
```rust
use pg_tviews::refresh::refresh_pk;
use pg_tviews::catalog::entity_for_table;

let oid = get_table_oid("public", "sales");
refresh_pk(oid, 42)?;
```

**After (v2.0)**:
```rust
use pg_tviews::refresh::refresh_tview_row;

refresh_tview_row("public.sales", 42)?;
```

**Why**: Clearer naming, no need to understand Oid representation

**Migration Steps**:
1. Replace `refresh_pk(oid, pk)` calls
2. Use string names instead of Oid lookups
3. Update imports

---

### 2. Error Handling (REQUIRED)

**Change**: Consolidated error variants

**Before (v1.x)**:
```rust
match result {
    Err(TViewError::MetadataNotFound { entity }) => {
        println!("Entity {} not found", entity);
    }
    Err(TViewError::CacheMiss { key }) => {
        println!("Cache miss for key {}", key);
    }
    Err(TViewError::RefreshFailed { reason }) => {
        println!("Refresh failed: {}", reason);
    }
    // ... many more variants
    Err(e) => {
        println!("Other error: {:?}", e);
    }
    Ok(_) => println!("Success"),
}
```

**After (v2.0)**:
```rust
match result {
    Err(TViewError::NotFound { entity, reason }) => {
        println!("Entity {} not found: {}", entity, reason);
    }
    Err(TViewError::Refresh { entity, reason }) => {
        println!("Refresh failed for {}: {}", entity, reason);
    }
    Err(TViewError::Internal { reason }) => {
        println!("Internal error: {}", reason);
    }
    Ok(_) => println!("Success"),
}
```

**Why**: Simpler error handling, fewer variants to match

**Migration Steps**:
1. Review all `match` statements on `TViewError`
2. Consolidate similar error cases
3. Update error field access (some fields renamed)

---

### 3. Refresh Function Consolidation (REQUIRED)

**Change**: Multiple refresh functions → single unified function

**Before (v1.x)**:
```sql
-- Different functions for different use cases
SELECT pg_tviews_refresh_one('public.sales', 42);
SELECT pg_tviews_refresh_batch('public.sales', ARRAY[1,2,3]);
SELECT pg_tviews_refresh_all('public.%');
SELECT pg_tviews_refresh_cascade('public.sales');
```

**After (v2.0)**:
```sql
-- Single function with flexible parameters
SELECT pg_tviews_refresh(
    tview_name => 'public.sales',
    primary_keys => ARRAY[42]  -- Optional, omit for all
);

SELECT pg_tviews_refresh(
    tview_name => 'public.sales',
    primary_keys => ARRAY[1,2,3]
);

SELECT pg_tviews_refresh(tview_name => 'public.%');

SELECT pg_tviews_refresh(
    tview_name => 'public.sales',
    cascade => true
);
```

**Why**: Simpler API, fewer functions to remember

**Migration Steps**:
1. Replace `pg_tviews_refresh_one()` with `pg_tviews_refresh(primary_keys => ARRAY[...])`
2. Replace `pg_tviews_refresh_batch()` with `pg_tviews_refresh(primary_keys => ARRAY[...])`
3. Replace `pg_tviews_refresh_all()` with `pg_tviews_refresh()` (omit primary_keys)
4. Replace `pg_tviews_refresh_cascade()` with `pg_tviews_refresh(cascade => true)`

---

### 4. Debug Function Removal (OPTIONAL)

**Change**: Queue debugging functions removed

**Before (v1.x)**:
```sql
-- These functions exist but were never recommended for production
SELECT pg_tviews_debug_queue_status();
SELECT pg_tviews_debug_queue_items();
SELECT pg_tviews_debug_worker_status();
```

**After (v2.0)**:
```sql
-- Use proper monitoring/logging instead
-- No direct replacement provided
```

**Why**: Experimental features not intended for production use

**Migration Steps**:
1. Remove any calls to debug functions
2. Implement proper monitoring if needed

---

### 5. Schema Changes (TRANSPARENT)

**Change**: Internal schema reorganization

**Action Required**: None - automatic migration during upgrade

**What Changes**:
- Internal tables moved to `pg_tviews` schema
- Table names clarified
- Metadata structure enhanced

---

### 6. Refresh Policies (OPTIONAL)

**Change**: New configurable refresh policies

**Before (v1.x)**:
```sql
-- Fixed behavior
SELECT pg_tviews_refresh_one('public.sales', 42);
```

**After (v2.0)**:
```sql
-- Configurable behavior (optional)
SELECT pg_tviews_refresh(
    tview_name => 'public.sales',
    primary_keys => ARRAY[42],
    priority => 'high',     -- NEW: priority levels
    timeout => '30s',       -- NEW: timeout control
    retry_count => 3        -- NEW: retry behavior
);
```

**Why**: Better control over refresh behavior

**Migration Steps**:
1. Optional - existing code continues to work
2. Add parameters only if needed

## Step-by-Step Migration Process

### Phase 1: Preparation (1-2 weeks before upgrade)

1. **Review Codebase**:
   ```bash
   # Find all refresh_pk calls
   grep -r "refresh_pk" src/ --include="*.rs"

   # Find all TViewError matches
   grep -r "TViewError::" src/ --include="*.rs"

   # Find all refresh function calls
   grep -r "pg_tviews_refresh" sql/ --include="*.sql"
   ```

2. **Create Migration Branch**:
   ```bash
   git checkout -b migration-v2.0
   ```

3. **Backup Database**:
   ```bash
   pg_dump mydatabase > backup_before_v2.sql
   ```

### Phase 2: Code Updates (1-2 days)

1. **Update Function Calls**:
   ```rust
   // Find and replace refresh_pk calls
   // Use your IDE's find/replace or sed
   sed -i 's/refresh_pk(/refresh_tview_row(/g' src/**/*.rs
   ```

2. **Update Error Handling**:
   ```rust
   // This requires manual review of each match statement
   // Look for TViewError matches and consolidate variants
   ```

3. **Update SQL Calls**:
   ```sql
   -- Use sed or manual replacement
   sed -i 's/pg_tviews_refresh_one/pg_tviews_refresh/g' sql/**/*.sql
   sed -i 's/pg_tviews_refresh_batch/pg_tviews_refresh/g' sql/**/*.sql
   ```

### Phase 3: Testing (1-2 days)

1. **Compile Check**:
   ```bash
   cargo check
   ```

2. **Unit Tests**:
   ```bash
   cargo test
   ```

3. **Integration Tests**:
   ```bash
   # Run your test suite
   ./run-tests.sh
   ```

4. **Staging Deployment**:
   ```bash
   # Deploy to staging environment
   # Run full test suite against staging
   ```

### Phase 4: Production Upgrade

1. **Maintenance Window**:
   ```bash
   # Schedule downtime
   pg_ctl stop
   ```

2. **Upgrade Binary**:
   ```bash
   # Replace with v2.0 binary
   cp pg_tviews-v2.0.so /usr/lib/postgresql/16/lib/
   ```

3. **Restart PostgreSQL**:
   ```bash
   pg_ctl start
   ```

4. **Verify Upgrade**:
   ```sql
   SELECT pg_tviews_version();
   -- Should return '2.0.0'
   ```

5. **Run Smoke Tests**:
   ```sql
   -- Test basic functionality
   SELECT pg_tviews_refresh(tview_name => 'test_table');
   ```

## Rollback Procedures

### Immediate Rollback (< 1 hour)

If issues occur immediately after upgrade:

```bash
# Stop PostgreSQL
pg_ctl stop

# Restore v1.x binary
cp pg_tviews-v1.x.so /usr/lib/postgresql/16/lib/

# Start PostgreSQL
pg_ctl start

# Verify rollback
SELECT pg_tviews_version(); -- Should return '1.x.x'
```

### Data Migration Rollback (< 24 hours)

If data corruption occurs:

```sql
-- Restore from backup
psql mydatabase < backup_before_v2.sql
```

### Extended Support

- v1.x remains available for download for 30 days after v2.0 release
- Community support for rollback issues
- Enterprise support includes rollback assistance

## Troubleshooting

### Common Issues

**Compilation Errors**:
```
error[E0425]: cannot find function `refresh_pk` in module `refresh`
```
**Solution**: Update to `refresh_tview_row` and change parameter types.

**Runtime Errors**:
```
ERROR: function pg_tviews_refresh_one(unknown, integer) does not exist
```
**Solution**: Update to `pg_tviews_refresh(tview_name => ..., primary_keys => ARRAY[...])`.

**Error Handling Issues**:
```
error[E0004]: non-exhaustive patterns: `TViewError::CacheMiss{..}` not covered
```
**Solution**: Consolidate error patterns to use the new unified variants.

### Getting Help

- **Documentation**: This guide and [BREAKING_CHANGES_V2.0.md](../BREAKING_CHANGES_V2.0.md)
- **Community**: [GitHub Discussions](https://github.com/your-org/pg_tviews/discussions)
- **Issues**: [GitHub Issues](https://github.com/your-org/pg_tviews/issues)
- **Enterprise**: Contact support for priority assistance

### Migration Checklist

- [ ] Code reviewed for all breaking changes
- [ ] Function calls updated (`refresh_pk` → `refresh_tview_row`)
- [ ] Error handling updated (consolidated variants)
- [ ] SQL calls updated (unified `pg_tviews_refresh`)
- [ ] Debug functions removed
- [ ] Tests pass with new code
- [ ] Staging environment tested
- [ ] Backup created
- [ ] Rollback plan documented
- [ ] Maintenance window scheduled

## Success Metrics

After migration, verify:

- [ ] All tests pass
- [ ] Performance meets expectations
- [ ] Error rates unchanged
- [ ] Monitoring alerts configured
- [ ] Documentation updated

## Timeline Expectations

| Phase | Duration | Parallel Work |
|-------|----------|---------------|
| Preparation | 1-2 weeks | Code review |
| Code Updates | 1-2 days | Testing |
| Testing | 1-2 days | Staging deployment |
| Production | 1 hour | Monitoring |

Total: 2-3 weeks for typical migration.</content>
<parameter name="filePath">docs/migration/v2.0-upgrade-guide.md