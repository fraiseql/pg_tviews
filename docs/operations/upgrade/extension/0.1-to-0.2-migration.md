# pg_tviews 0.1 to 0.2 Major Migration

## Scope
Migrating from pg_tviews 0.1.x to 0.2.x with breaking API changes and data migration requirements.

## Risk Level
**HIGH** - Major version changes include breaking changes and require careful planning

## Prerequisites
- pg_tviews 0.1.x currently installed and stable
- Full database backup completed and tested
- Maintenance window scheduled (30-90 minutes)
- Application code reviewed for breaking changes
- Staging environment for testing migration
- Reviewed [BREAKING_CHANGES_V2.0.md](../../../BREAKING_CHANGES_V2.0.md)

## Impact Assessment

### Downtime
- **Planned**: 15-60 minutes for migration
- **Unplanned**: 60-120 minutes if issues occur

### Breaking Changes
- **API Changes**: Function signatures modified (`refresh_pk` → `refresh_tview_row`)
- **Error Handling**: Consolidated error variants (15+ → 3 core variants)
- **SQL Functions**: Unified refresh functions (multiple → single `pg_tviews_refresh`)
- **Debug Functions**: Removed experimental debugging functions

### Data Migration
- **Schema Changes**: Internal metadata structure updates
- **TVIEW Recreation**: May require recreating TVIEWs with new parameters
- **Configuration**: Updated settings and parameters

## Pre-Migration Planning

### Code Impact Analysis
```bash
# Search for affected API usage in application code
echo "Searching for breaking API usage..."

# Find refresh_pk calls
grep -r "refresh_pk" /path/to/application/code/

# Find old error handling patterns
grep -r "TViewError::MetadataNotFound\|TViewError::CacheMiss\|TViewError::RefreshFailed" /path/to/application/code/

# Find old SQL function calls
grep -r "pg_tviews_refresh_one\|pg_tviews_refresh_batch\|pg_tviews_refresh_all" /path/to/sql/scripts/

# Find debug function usage
grep -r "pg_tviews_debug_\|pg_tviews_performance_stats\|pg_tviews_create\|pg_tviews_drop" /path/to/code/
```

### Migration Testing Plan
- [ ] Create staging environment with production data copy
- [ ] Update application code for new API
- [ ] Test all TVIEW operations with new version
- [ ] Validate performance and functionality
- [ ] Test rollback procedures

### Communication Plan
- [ ] Application development teams notified
- [ ] Business stakeholders informed of changes
- [ ] Testing schedule coordinated
- [ ] Rollback procedures documented and shared

## Step-by-Step Migration Procedure

### Phase 1: Preparation (60 minutes)

#### Step 1: Environment Setup
```bash
# Install pg_tviews 0.2.x alongside 0.1.x
# Download and build new version
wget https://github.com/your-org/pg_tviews/releases/download/v0.2.0/pg_tviews-0.2.0.tar.gz
tar -xzf pg_tviews-0.2.0.tar.gz
cd pg_tviews-0.2.0
make && sudo make install

# Verify installation
ls -la /usr/lib/postgresql/*/lib/ | grep tviews
```

#### Step 2: Application Code Updates
Update application code for breaking changes:

**Rust Code Changes:**
```rust
// OLD (0.1.x)
use pg_tviews::refresh::refresh_pk;
let oid = get_table_oid("public", "sales")?;
refresh_pk(oid, 42)?;

// NEW (0.2.x)
use pg_tviews::refresh::refresh_tview_row;
refresh_tview_row("public.sales", 42)?;
```

**Error Handling Changes:**
```rust
// OLD (0.1.x)
match result {
    Err(TViewError::MetadataNotFound { entity }) => handle_error(entity),
    Err(TViewError::CacheMiss { key }) => handle_cache_miss(key),
    Err(TViewError::RefreshFailed { reason }) => handle_refresh_error(reason),
    // ... many more variants
}

// NEW (0.2.x)
match result {
    Err(TViewError::NotFound { entity, reason }) => handle_not_found(entity, reason),
    Err(TViewError::Refresh { entity, reason }) => handle_refresh_error(entity, reason),
    Err(TViewError::Internal { reason }) => handle_internal_error(reason),
}
```

**SQL Function Changes:**
```sql
-- OLD (0.1.x)
SELECT pg_tviews_refresh_one('public.sales', 42);
SELECT pg_tviews_refresh_batch('public.sales', ARRAY[1,2,3]);

-- NEW (0.2.x)
SELECT pg_tviews_refresh(tview_name => 'public.sales', primary_keys => ARRAY[42]);
SELECT pg_tviews_refresh(tview_name => 'public.sales', primary_keys => ARRAY[1,2,3]);
```

#### Step 3: Pre-Migration Backup
```sql
-- Create comprehensive backup
BACKUP_DIR="/backups/pre-0.2-migration-$(date +%Y%m%d_%H%M%S)"
mkdir -p $BACKUP_DIR

# Full database dump
pg_dump --compress=9 --format=directory --jobs=4 \
    --file=$BACKUP_DIR/full_backup \
    $DB_NAME

# TVIEW-specific metadata backup
psql -d $DB_NAME -c "
COPY (
    SELECT entity_name, last_refreshed, last_refresh_duration_ms,
           last_error, pg_tviews_version() as version_before
    FROM pg_tviews_metadata
) TO '$BACKUP_DIR/tview_metadata_before.csv' WITH CSV HEADER;
"
```

### Phase 2: Migration Execution (30 minutes)

#### Step 4: Extension Update
```sql
-- Update extension (this will fail due to breaking changes)
-- We need to handle this carefully
ALTER EXTENSION pg_tviews UPDATE TO '0.2.0';
-- Note: This may fail - see troubleshooting below
```

#### Step 5: Handle Breaking Changes
```sql
-- Drop and recreate extension with new version
DROP EXTENSION pg_tviews;

-- Install new version
CREATE EXTENSION pg_tviews VERSION '0.2.0';

-- Verify new version
SELECT pg_tviews_version();
```

#### Step 6: TVIEW Recreation
```sql
-- Recreate TVIEWs with new API
-- This requires knowing the original table relationships

-- Example recreation script (adjust for your schema)
DO $$
DECLARE
    tview_record RECORD;
BEGIN
    -- Get list of TVIEWs that need recreation
    CREATE TEMP TABLE tviews_to_recreate AS
    SELECT entity_name, 'source_table_' || entity_name as source_table
    FROM pg_tviews_metadata;  -- This table may not exist in 0.2.0

    -- Recreate each TVIEW
    FOR tview_record IN SELECT * FROM tviews_to_recreate LOOP
        -- Drop old TVIEW if it exists
        EXECUTE 'DROP VIEW IF EXISTS ' || tview_record.entity_name;

        -- Recreate with new API
        EXECUTE 'SELECT pg_tviews_convert_existing_table(''' || tview_record.source_table || ''');';

        RAISE NOTICE 'Recreated TVIEW: %', tview_record.entity_name;
    END LOOP;
END $$;
```

### Phase 3: Post-Migration Validation (30 minutes)

#### Step 7: Functionality Testing
```sql
-- Test new API functions
SELECT pg_tviews_health_check();

-- Test refresh operations with new API
SELECT pg_tviews_refresh(tview_name => 'test_tview', primary_keys => ARRAY[1,2,3]);

-- Verify TVIEWs are accessible
SELECT COUNT(*) FROM test_tview LIMIT 1;
```

#### Step 8: Application Integration Testing
```sql
-- Test application connectivity
-- Replace with your application test commands
curl -f http://app-server/health

-- Test TVIEW-dependent functionality
-- Run your application's TVIEW integration tests
```

#### Step 9: Performance Validation
```sql
-- Compare performance with old version
SELECT
    'Migration performance check' as test,
    COUNT(*) as tviews_present,
    AVG(last_refresh_duration_ms) as avg_refresh_time,
    COUNT(*) FILTER (WHERE last_error IS NOT NULL) as errors_present
FROM pg_tviews_metadata;
```

## Rollback Procedures

### Immediate Rollback (< 15 minutes)
If critical issues discovered immediately:

```sql
-- Drop new extension
DROP EXTENSION pg_tviews;

-- Install old version
CREATE EXTENSION pg_tviews VERSION '0.1.x';

-- Restore from backup if needed
pg_restore -d $DB_NAME --jobs=4 $BACKUP_DIR/full_backup
```

### Complete Rollback (< 60 minutes)
If major issues require full system rollback:

```sql
-- Stop application services
sudo systemctl stop application-service

-- Restore database from backup
dropdb $DB_NAME
createdb $DB_NAME
pg_restore -d $DB_NAME --jobs=4 $BACKUP_DIR/full_backup

-- Reinstall old extension
psql -d $DB_NAME -c "CREATE EXTENSION pg_tviews VERSION '0.1.x';"

-- Restart application services
sudo systemctl start application-service
```

## Troubleshooting

### Extension Update Fails
```sql
-- Check for dependent objects
SELECT * FROM pg_depend WHERE objid = (
    SELECT oid FROM pg_extension WHERE extname = 'pg_tviews'
);

-- Force drop if needed (CAUTION: may break dependencies)
DROP EXTENSION pg_tviews CASCADE;

-- Recreate with new version
CREATE EXTENSION pg_tviews VERSION '0.2.0';
```

### TVIEW Recreation Issues
```sql
-- Check source table exists
SELECT schemaname, tablename
FROM pg_tables
WHERE tablename = 'source_table_name';

-- Verify table structure is compatible
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'source_table_name'
ORDER BY ordinal_position;
```

### Application Integration Problems
```sql
-- Test basic connectivity
psql -d $DB_NAME -c "SELECT 1;"

-- Test TVIEW access
psql -d $DB_NAME -c "SELECT COUNT(*) FROM your_tview;"

-- Check for API usage errors in logs
grep -i "tview\|refresh" /var/log/application/*.log
```

## Migration Validation Checklist

### Pre-Migration
- [ ] Code updated for new API
- [ ] Staging environment tested
- [ ] Backup verified
- [ ] Rollback procedures tested
- [ ] Communication plan executed

### During Migration
- [ ] Extension updated successfully
- [ ] TVIEWs recreated without errors
- [ ] Application services restarted
- [ ] Basic functionality verified

### Post-Migration
- [ ] All TVIEWs accessible and functional
- [ ] Application working normally
- [ ] Performance within acceptable ranges
- [ ] Error rates normal
- [ ] Monitoring systems updated

## Success Criteria

### Technical Success
- [ ] pg_tviews 0.2.0 installed and functional
- [ ] All TVIEWs recreated and operational
- [ ] New API functions working
- [ ] Old deprecated functions removed
- [ ] Performance maintained or improved

### Application Success
- [ ] Application code updated and deployed
- [ ] All TVIEW operations working
- [ ] User functionality unaffected
- [ ] Error handling updated
- [ ] Testing completed successfully

### Business Success
- [ ] System availability maintained
- [ ] User impact minimized
- [ ] Migration completed within timeline
- [ ] Rollback capability verified
- [ ] Lessons learned documented

## Performance Expectations

### 0.2.x Improvements
- Better error handling performance
- Simplified API reduces overhead
- Improved refresh operation efficiency
- Better memory management
- Enhanced monitoring capabilities

### Migration Impact
- Initial performance may be similar
- Benefits realized after optimization
- Monitoring improvements provide better visibility
- Simplified API reduces development overhead

## Documentation Updates

### Post-Migration Tasks
- [ ] Update application documentation
- [ ] Update monitoring dashboards
- [ ] Update deployment scripts
- [ ] Document lessons learned
- [ ] Plan next migration timeline

### Change Management
- [ ] Migration record completed
- [ ] Risk assessment updated
- [ ] Success metrics documented
- [ ] Future migration planning initiated

## Related Guides

- [Extension Minor Update](extension-minor-update.md) - For patch-level updates
- [BREAKING_CHANGES_V2.0.md](../../../BREAKING_CHANGES_V2.0.md) - Complete breaking changes list
- [Migration Guide](../../../migration/v2.0-upgrade-guide.md) - Step-by-step migration instructions
- [Troubleshooting Upgrades](../postgresql/troubleshooting-upgrades.md) - For migration issue resolution</content>
<parameter name="filePath">docs/operations/upgrade/extension/0.1-to-0.2-migration.md